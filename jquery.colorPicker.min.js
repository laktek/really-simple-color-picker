(function($){var selectorOwner,activePalette,cItterate=0,templates={control:$('<div class="colorPicker-picker">&nbsp;</div>'),palette:$('<div id="colorPicker_palette" class="colorPicker-palette" />'),swatch:$('<div class="colorPicker-swatch">&nbsp;</div>'),hexLabel:$('<label for="colorPicker_hex">Hex</label>'),hexField:$('<input type="text" id="colorPicker_hex" />'),personalColors:$('<div class="colorPicker-swatch-personal">&nbsp;</div>')},transparent="transparent",lastColor;$.fn.colorPicker=function(options){return this.each(function(){var element=
$(this),opts=$.extend({},$.fn.colorPicker.defaults,options),defaultColor=$.fn.colorPicker.toHex(element.val().length>0?element.val():opts.pickerDefault),newControl=templates.control.clone(),newPalette=templates.palette.clone().attr("id","colorPicker_palette-"+cItterate),newHexLabel=templates.hexLabel.clone(),newHexField=templates.hexField.clone(),personalColors=templates.personalColors.clone(),paletteId=newPalette[0].id,swatch;element.data("colorPickerId","colorPicker_palette-"+cItterate);element.data("colorPickerHex",
"colorPicker_hex-"+cItterate);$.each(opts.colors,function(i){swatch=templates.swatch.clone();if(opts.colors[i]===transparent){swatch.addClass(transparent).text("X");$.fn.colorPicker.bindPalette(newHexField,swatch,transparent)}else{swatch.css("background-color","#"+this);$.fn.colorPicker.bindPalette(newHexField,swatch)}swatch.appendTo(newPalette)});newHexLabel.attr("for","colorPicker_hex-"+cItterate);newHexField.attr({"id":"colorPicker_hex-"+cItterate,"value":defaultColor});newHexField.bind("keydown",
function(event){if(event.keyCode===13){var hexColor=$.fn.colorPicker.toHex($(this).val());$.fn.colorPicker.changeColor(hexColor?hexColor:element.val())}if(event.keyCode===27)$.fn.colorPicker.hidePalette()});newHexField.bind("keyup",function(event){var hexColor=$.fn.colorPicker.toHex($(event.target).val());$.fn.colorPicker.previewColor(hexColor?hexColor:element.val())});$('<div class="colorPicker_hexWrap" />').append(newHexLabel).appendTo(newPalette);newPalette.find(".colorPicker_hexWrap").append(newHexField);
if(opts.showHexField===false){newHexField.hide();newHexLabel.hide()}newPalette.find(".colorPicker_hexWrap").append(personalColors);$("body").append(newPalette);newPalette.hide();newControl.css("background-color",defaultColor);newControl.bind("click",function(){if(element.is(":not(:disabled)"))$.fn.colorPicker.togglePalette($("#"+paletteId),$(this))});if(options&&options.onColorChange)newControl.data("onColorChange",options.onColorChange);else newControl.data("onColorChange",function(){});if(controlText=
element.data("text"))newControl.html(controlText);element.after(newControl);element.bind("change",function(){element.next(".colorPicker-picker").css("background-color",$.fn.colorPicker.toHex($(this).val()))});if(element[0].tagName.toLowerCase()==="input")element.each(function(){this.type="hidden"});else element.hide();cItterate++})};$.extend(true,$.fn.colorPicker,{toHex:function(color){if(color.match(/[0-9A-F]{6}|[0-9A-F]{3}$/i))return color.charAt(0)==="#"?color:"#"+color;else if(color.match(/^rgb\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)$/)){var c=
[parseInt(RegExp.$1,10),parseInt(RegExp.$2,10),parseInt(RegExp.$3,10)],pad=function(str){if(str.length<2)for(var i=0,len=2-str.length;i<len;i++)str="0"+str;return str};if(c.length===3){var r=pad(c[0].toString(16)),g=pad(c[1].toString(16)),b=pad(c[2].toString(16));return"#"+r+g+b}}else return false},checkMouse:function(event,paletteId){var selector=activePalette,selectorParent=$(event.target).parents("#"+selector.attr("id")).length;if(event.target===$(selector)[0]||event.target===selectorOwner[0]||
selectorParent>0)return;$.fn.colorPicker.hidePalette()},hidePalette:function(){$(document).unbind("mousedown",$.fn.colorPicker.checkMouse);$(".colorPicker-palette").hide()},showPalette:function(palette){var hexColor=selectorOwner.prev("input").val();palette.css({top:selectorOwner.offset().top+selectorOwner.outerHeight(),left:selectorOwner.offset().left});$("#color_value").val(hexColor);palette.show();$(document).bind("mousedown",$.fn.colorPicker.checkMouse)},togglePalette:function(palette,origin){if(origin)selectorOwner=
origin;activePalette=palette;if(activePalette.is(":visible"))$.fn.colorPicker.hidePalette();else $.fn.colorPicker.showPalette(palette)},changeColor:function(value){selectorOwner.css("background-color",value);selectorOwner.prev("input").val(value).change();$.fn.colorPicker.hidePalette();selectorOwner.data("onColorChange").call(selectorOwner,$(selectorOwner).prev("input").attr("id"),value)},previewColor:function(value){selectorOwner.css("background-color",value)},bindPalette:function(paletteInput,element,
color){color=color?color:$.fn.colorPicker.toHex(element.css("background-color"));element.bind({click:function(ev){lastColor=color;$.fn.colorPicker.changeColor(color)},mouseover:function(ev){lastColor=paletteInput.val();$(this).css("border-color","#598FEF");paletteInput.val(color);$.fn.colorPicker.previewColor(color)},mouseout:function(ev){$(this).css("border-color","#000");paletteInput.val(selectorOwner.css("background-color"));paletteInput.val(lastColor);$.fn.colorPicker.previewColor(lastColor)}})},
addPersonalColor:function(options){var colors;var limit=8;if(typeof options.colors=="string"){colors=[];colors[0]=options.colors}else colors=options.colors;element=$(options.element);if(element.length<=0)return false;var newControl=templates.control.clone(),personalColors=templates.personalColors.clone(),paletteId=element.data("colorPickerId"),swatch;var hexFieldStr=element.data("colorPickerHex");var hexField=$("#"+hexFieldStr);for(var i=0;i<colors.length;i++)colors[i]=$.fn.colorPicker.toHex(colors[i]);
$.each(colors,function(i){swatch=templates.swatch.clone();if(colors[i]===transparent){swatch.addClass(transparent).text("X");$.fn.colorPicker.bindPalette(hexField,swatch,transparent)}else{swatch.css("background-color",this);$.fn.colorPicker.bindPalette(hexField,swatch)}swatch.prependTo($("#"+paletteId+" .colorPicker-swatch-personal"))});return true},resetPersonalColor:function(options){element=$(options.element);if(element.length<=0)return false;var paletteId=element.data("colorPickerId"),swatch;
$("#"+paletteId+" .colorPicker-swatch-personal").html("&nbsp;");return true}});$.fn.colorPicker.defaults={pickerDefault:"FFFFFF",colors:["000000","993300","333300","000080","333399","333333","800000","FF6600","808000","008000","008080","0000FF","666699","808080","FF0000","FF9900","99CC00","339966","33CCCC","3366FF","800080","999999","FF00FF","FFCC00","FFFF00","00FF00","00FFFF","00CCFF","993366","C0C0C0","FF99CC","FFCC99","FFFF99","CCFFFF","99CCFF","FFFFFF"],addColors:[],showHexField:true}})(jQuery);